name: Build Package ARM64 (Reusable)

on:
  workflow_call:
    inputs:
      build_flags:
        description: 'Flags to pass to build.sh (e.g., "--build appimage --clean no")'
        required: false
        type: string
        default: ""
      artifact_suffix:
        description: "Suffix for the artifact name (e.g., deb, appimage, rpm)"
        required: true
        type: string
      release_tag:
        description: "Optional release tag (e.g., v1.3.2+claude1.1.799) to derive wrapper version"
        required: false
        type: string
        default: ""

jobs:
  build:
    runs-on: ubuntu-22.04-arm
    container: ${{ inputs.artifact_suffix == 'rpm' && 'fedora:42' || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Fedora)
        if: inputs.artifact_suffix == 'rpm'
        run: |
          dnf install -y git findutils

      - name: Install FUSE for AppImageTool (Ubuntu)
        if: inputs.artifact_suffix != 'rpm'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Make build script executable
        run: chmod +x ./build.sh

      - name: Run build script
        run: |
          TAG_FLAG=""
          if [[ -n "${{ inputs.release_tag }}" ]]; then
            TAG_FLAG="--release-tag ${{ inputs.release_tag }}"
          fi
          ./build.sh ${{ inputs.build_flags }} $TAG_FLAG

      - name: Verify SSH helper assets in package
        run: |
          chmod +x ./scripts/verify-claude-ssh-package.sh
          case "${{ inputs.artifact_suffix }}" in
            deb) pkg=$(ls -1 claude-desktop_*.deb | head -1) ;;
            rpm) pkg=$(ls -1 claude-desktop-*.rpm | head -1) ;;
            appimage) pkg=$(ls -1 claude-desktop-*.AppImage | grep -v '\.zsync$' | head -1) ;;
          esac
          ./scripts/verify-claude-ssh-package.sh "$pkg" "${{ inputs.artifact_suffix }}"

      - name: Upload ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-arm64-${{ inputs.artifact_suffix }}
          path: |
            claude-desktop_*.deb
            claude-desktop-*.rpm
            claude-desktop-*.AppImage
            claude-desktop-*.AppImage.zsync
          if-no-files-found: error
