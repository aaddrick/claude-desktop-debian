name: Build Package ARM64 (Reusable)

on:
  workflow_call:
    inputs:
      build_flags:
        description: 'Flags to pass to build.sh (e.g., "--build appimage --clean no")'
        required: false
        type: string
        default: ""
      artifact_suffix:
        description: "Suffix for the artifact name (e.g., deb, appimage, rpm)"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04-arm
    container: ${{ inputs.artifact_suffix == 'rpm' && 'fedora:42' || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Fedora)
        if: inputs.artifact_suffix == 'rpm'
        run: |
          dnf install -y git findutils

      - name: Install FUSE for AppImageTool (Ubuntu)
        if: inputs.artifact_suffix != 'rpm'
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2

      - name: Make build script executable
        run: chmod +x ./build.sh

      - name: Run build script
        run: |
          ./build.sh ${{ inputs.build_flags }}

      - name: Upload ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-arm64-${{ inputs.artifact_suffix }}
          path: |
            claude-desktop_*.deb
            claude-desktop-*.rpm
            claude-desktop-*.AppImage
            claude-desktop-*.AppImage.zsync
          if-no-files-found: error
