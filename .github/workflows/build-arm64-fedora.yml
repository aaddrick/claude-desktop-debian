name: Build Package ARM64 (Reusable - Fedora)

on:
  workflow_call:
    inputs:
      build_flags:
        description: 'Flags to pass to build-fedora.sh (e.g., "--build appimage --clean no")'
        required: false
        type: string
        default: '' # Default is no extra flags
      artifact_suffix:
        description: 'Suffix for the artifact name (e.g., rpm, appimage)'
        required: true
        type: string

jobs:
  build:
    # Use ARM64 runner - GitHub provides these for open source projects
    # Alternative: Use QEMU emulation on ubuntu-latest if ARM64 runners are not available
    runs-on: ubuntu-22.04 # Will use QEMU emulation for ARM64

    steps:
    # Checkout code is needed within the reusable workflow itself
    - name: Checkout repository
      uses: actions/checkout@v4

    # Set up QEMU for ARM64 emulation if using ubuntu-latest
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    # Set up Docker Buildx for multi-platform builds
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build using Docker container with ARM64 emulation
    - name: Build ARM64 package using Docker
      run: |
        echo "Building ARM64 package with flags: ${{ inputs.build_flags }}"
        
        # Create a temporary Dockerfile for the build
        cat > Dockerfile.arm64 << 'EOF'
        FROM --platform=linux/arm64 fedora:39
        
        # Install build dependencies
        RUN dnf update -y && dnf install -y \
            rpm-build \
            rpmdevtools \
            p7zip \
            p7zip-plugins \
            wget \
            icoutils \
            ImageMagick \
            nodejs \
            npm \
            git \
            which \
            findutils \
            sed \
            tar \
            gzip \
            zsync
        
        # Set working directory
        WORKDIR /workspace
        
        # Copy source code
        COPY . .
        
        # Make build script executable
        RUN chmod +x ./build-fedora.sh
        
        # Set environment variable to indicate we're in a container
        ENV CONTAINER=true
        
        # Run the build
        ENTRYPOINT ["./build-fedora.sh"]
        EOF
        
        # Build the Docker image and run the build
        docker buildx build \
          --platform linux/arm64 \
          --load \
          -f Dockerfile.arm64 \
          -t claude-desktop-fedora-arm64 \
          .
        
        # Run the container to build the package
        docker run \
          --platform linux/arm64 \
          --rm \
          -v "$(pwd):/output" \
          claude-desktop-fedora-arm64 \
          ${{ inputs.build_flags }}
        
        # Clean up
        rm -f Dockerfile.arm64

    # Upload the built artifact for the release job
    - name: Upload ARM64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: package-arm64-${{ inputs.artifact_suffix }} # Unique name using suffix
        path: | # Adjust path based on expected output
          claude-desktop-*.rpm
          claude-desktop-*.AppImage
          claude-desktop-*.AppImage.zsync
        if-no-files-found: error # Fail if build didn't produce output