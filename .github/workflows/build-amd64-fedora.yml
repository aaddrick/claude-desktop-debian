name: Build Package AMD64 (Reusable - Fedora)

on:
  workflow_call:
    inputs:
      build_flags:
        description: 'Flags to pass to build-fedora.sh (e.g., "--build appimage --clean no")'
        required: false
        type: string
        default: '' # Default is no extra flags
      artifact_suffix:
        description: 'Suffix for the artifact name (e.g., rpm, appimage)'
        required: true
        type: string

jobs:
  build:
    # Use the standard GitHub-hosted runner for AMD64
    runs-on: ubuntu-22.04  # Pin to specific version for stability

    steps:
    # Checkout code is needed within the reusable workflow itself
    - name: Checkout repository
      uses: actions/checkout@v4

    # Set up Docker Buildx for container builds
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Build using Docker container with Fedora 42
    - name: Build AMD64 package using Docker
      run: |
        echo "Building AMD64 package with flags: ${{ inputs.build_flags }}"
        
        # Create a temporary Dockerfile for the build
        cat > Dockerfile.amd64 << 'EOF'
        FROM fedora:42
        
        # Install build dependencies (skip dnf update for speed)
        RUN dnf install -y --nodocs --setopt=install_weak_deps=False \
            rpm-build \
            rpmdevtools \
            p7zip \
            p7zip-plugins \
            wget \
            icoutils \
            ImageMagick \
            nodejs \
            npm \
            git \
            which \
            findutils \
            sed \
            tar \
            gzip && \
            dnf clean all && \
            # Try to install zsync from COPR, but don't fail if unavailable
            (timeout 120 dnf copr enable -y petersen/zsync && timeout 120 dnf install -y zsync) || \
            echo "zsync not available - AppImage .zsync files may not be generated"
        
        # Set working directory
        WORKDIR /workspace
        
        # Copy source code
        COPY . .
        
        # Make build script executable
        RUN chmod +x ./build-fedora.sh
        
        # Set environment variable to indicate we're in a container
        ENV CONTAINER=true
        
        # Run the build
        ENTRYPOINT ["./build-fedora.sh"]
        EOF
        
        # Build the Docker image and run the build
        docker buildx build \
          --platform linux/amd64 \
          --load \
          -f Dockerfile.amd64 \
          -t claude-desktop-fedora-amd64 \
          .
        
        # Run the container to build the package
        docker run \
          --platform linux/amd64 \
          --rm \
          -v "$(pwd):/output" \
          claude-desktop-fedora-amd64 \
          ${{ inputs.build_flags }}
        
        # Copy artifacts from container output to workflow directory
        ls -la
        
        # Clean up
        rm -f Dockerfile.amd64

    # Upload the built artifact for the release job
    - name: Upload AMD64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: package-amd64-${{ inputs.artifact_suffix }} # Unique name using suffix
        path: | # Adjust path based on expected output
          claude-desktop-*.rpm
          claude-desktop-*.AppImage
          claude-desktop-*.AppImage.zsync
        if-no-files-found: error # Fail if build didn't produce output