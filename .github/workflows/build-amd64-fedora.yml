name: Build Package AMD64 (Reusable - Fedora)

on:
  workflow_call:
    inputs:
      build_flags:
        description: 'Flags to pass to build-fedora.sh (e.g., "--build appimage --clean no")'
        required: false
        type: string
        default: '' # Default is no extra flags
      artifact_suffix:
        description: 'Suffix for the artifact name (e.g., rpm, appimage)'
        required: true
        type: string

jobs:
  build:
    # Use the standard GitHub-hosted runner for AMD64
    runs-on: ubuntu-22.04  # Pin to specific version for stability

    steps:
    # Checkout code is needed within the reusable workflow itself
    # because the caller only specifies 'uses:', it doesn't run steps before calling.
    - name: Checkout repository
      uses: actions/checkout@v4

    # Install RPM building tools and dependencies on Ubuntu
    - name: Install RPM build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          rpm \
          p7zip-full \
          wget \
          icoutils \
          imagemagick \
          fuse \
          zsync || {
            echo "Failed to install packages. Trying alternative packages..."
            sudo apt-get install -y \
              rpm \
              p7zip-full \
              wget \
              icoutils \
              imagemagick-6.q16 \
              libfuse2 \
              zsync
          }

    # Install Node.js 20+ which is required for the build
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Make build script executable
      run: chmod +x ./build-fedora.sh

    - name: Run Fedora build script
      run: |
        echo "Running AMD64 Fedora build with flags: ${{ inputs.build_flags }}"
        # No sudo needed if runner user has permissions or build script handles it internally
        ./build-fedora.sh ${{ inputs.build_flags }}

    # Upload the built artifact for the release job
    - name: Upload AMD64 Artifact
      uses: actions/upload-artifact@v4
      with:
        name: package-amd64-${{ inputs.artifact_suffix }} # Unique name using suffix
        path: | # Adjust path based on expected output
          claude-desktop-*.rpm
          claude-desktop-*.AppImage
          claude-desktop-*.AppImage.zsync
        if-no-files-found: error # Fail if build didn't produce output