name: Test Build Script Flags (Reusable - Fedora)

on:
  workflow_call: # Make this workflow reusable
  workflow_dispatch: # Allows manual triggering for testing

jobs:
  test-flags:
    runs-on: ubuntu-22.04  # Pin to specific version for stability
    container:
      image: fedora:42

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # Install dependencies needed for flag testing
    - name: Install basic dependencies
      run: |
        dnf install -y rpm-build git which findutils

    - name: Make build script executable
      run: chmod +x ./build-fedora.sh

    # Test Case 1: Defaults (rpm, clean=yes)
    - name: Test Case 1 - Defaults (rpm, clean=yes)
      run: |
        echo "--- Running Test Case 1: ./build-fedora.sh --test-flags ---"
        set +e  # Allow script to fail without stopping the test
        OUTPUT=$(./build-fedora.sh --test-flags 2>&1)
        EXIT_CODE=$?
        set -e  # Re-enable error checking
        echo "$OUTPUT" # Print output for logs
        echo "Script exit code: $EXIT_CODE"
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "ERROR: Script failed with exit code $EXIT_CODE"
          exit 1
        fi
        
        echo "--- Verifying Test Case 1 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 1 Passed"

    # Test Case 2: --build rpm (clean=yes)
    - name: Test Case 2 - --build rpm (clean=yes)
      run: |
        echo "--- Running Test Case 2: ./build-fedora.sh --build rpm --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build rpm --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 2 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 2 Passed"

    # Test Case 3: --build appimage (clean=yes)
    - name: Test Case 3 - --build appimage (clean=yes)
      run: |
        echo "--- Running Test Case 3: ./build-fedora.sh --build appimage --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build appimage --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 3 ---"
        echo "$OUTPUT" | grep -q "Build Format: appimage" || (echo "ERROR: Expected 'Build Format: appimage'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 3 Passed"

    # Test Case 4: --clean yes (build=rpm)
    - name: Test Case 4 - --clean yes (build=rpm)
      run: |
        echo "--- Running Test Case 4: ./build-fedora.sh --clean yes --test-flags ---"
        OUTPUT=$(./build-fedora.sh --clean yes --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 4 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 4 Passed"

    # Test Case 5: --clean no (build=rpm)
    - name: Test Case 5 - --clean no (build=rpm)
      run: |
        echo "--- Running Test Case 5: ./build-fedora.sh --clean no --test-flags ---"
        OUTPUT=$(./build-fedora.sh --clean no --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 5 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: no" || (echo "ERROR: Expected 'Clean Action: no'" && exit 1)
        echo "SUCCESS: Test Case 5 Passed"

    # Test Case 6: --build rpm --clean yes
    - name: Test Case 6 - --build rpm --clean yes
      run: |
        echo "--- Running Test Case 6: ./build-fedora.sh --build rpm --clean yes --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build rpm --clean yes --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 6 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 6 Passed"

    # Test Case 7: --build rpm --clean no
    - name: Test Case 7 - --build rpm --clean no
      run: |
        echo "--- Running Test Case 7: ./build-fedora.sh --build rpm --clean no --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build rpm --clean no --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 7 ---"
        echo "$OUTPUT" | grep -q "Build Format: rpm" || (echo "ERROR: Expected 'Build Format: rpm'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: no" || (echo "ERROR: Expected 'Clean Action: no'" && exit 1)
        echo "SUCCESS: Test Case 7 Passed"

    # Test Case 8: --build appimage --clean yes
    - name: Test Case 8 - --build appimage --clean yes
      run: |
        echo "--- Running Test Case 8: ./build-fedora.sh --build appimage --clean yes --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build appimage --clean yes --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 8 ---"
        echo "$OUTPUT" | grep -q "Build Format: appimage" || (echo "ERROR: Expected 'Build Format: appimage'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: yes" || (echo "ERROR: Expected 'Clean Action: yes'" && exit 1)
        echo "SUCCESS: Test Case 8 Passed"

    # Test Case 9: --build appimage --clean no
    - name: Test Case 9 - --build appimage --clean no
      run: |
        echo "--- Running Test Case 9: ./build-fedora.sh --build appimage --clean no --test-flags ---"
        OUTPUT=$(./build-fedora.sh --build appimage --clean no --test-flags)
        echo "$OUTPUT"
        echo "--- Verifying Test Case 9 ---"
        echo "$OUTPUT" | grep -q "Build Format: appimage" || (echo "ERROR: Expected 'Build Format: appimage'" && exit 1)
        echo "$OUTPUT" | grep -q "Clean Action: no" || (echo "ERROR: Expected 'Clean Action: no'" && exit 1)
        echo "SUCCESS: Test Case 9 Passed"