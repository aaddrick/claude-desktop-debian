name: CI
run-name: |
  CI: ${{
    github.event_name == 'pull_request' && format('PR #{0} by @{1} - {2}', github.event.pull_request.number, github.actor, github.event.pull_request.title) ||
    github.event_name == 'push' && github.event.head_commit && format('Push by @{0} - {1}', github.actor, github.event.head_commit.message) ||
    format('{0} triggered by @{1}', github.event_name, github.actor)
  }}

on:
  push:
    branches:
      - main
    paths:
      - "build.sh"
      - "scripts/**"
      - ".github/workflows/**"
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test-flags:
    name: Test Flags Parsing
    uses: ./.github/workflows/test-flags.yml

  build-amd64:
    name: Build AppImage (amd64)
    needs: test-flags

    uses: ./.github/workflows/build-amd64.yml
    with:
      build_flags: "--build appimage --clean no"
      artifact_suffix: "appimage"
      release_tag: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}

  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [test-flags, build-amd64]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download AMD64 AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: package-amd64-appimage
          path: artifacts/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*

  update-aur-repo:
    name: Update AUR Package (DRY RUN)
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [release]
    runs-on: ubuntu-latest

    steps:
      - name: Download AMD64 AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: package-amd64-appimage
          path: artifacts/

      - name: List downloaded artifacts
        run: |
          echo "=== Artifacts directory ==="
          ls -lah artifacts/
          echo ""
          echo "=== File types ==="
          file artifacts/* || true

      - name: Extract version components from tag
        id: version
        run: |
          tag="${GITHUB_REF_NAME}"
          echo "Raw tag: $tag"

          # Tag format: v1.3.8+claude1.1.799
          # pkgver for AUR: 1.3.8+claude1.1.799
          pkgver="${tag#v}"
          # Wrapper version: 1.3.8 (before +claude)
          wrapper_ver="${pkgver%%+claude*}"
          # Claude version: 1.1.799 (after +claude)
          claude_ver="${pkgver#*+claude}"
          # AppImage filename: claude-desktop-{claude_ver}-{wrapper_ver}-amd64.AppImage
          appimage_name="claude-desktop-${claude_ver}-${wrapper_ver}-amd64.AppImage"

          echo "pkgver=$pkgver" >> "$GITHUB_OUTPUT"
          echo "appimage_name=$appimage_name" >> "$GITHUB_OUTPUT"

          echo ""
          echo "=== Parsed version components ==="
          echo "  pkgver:        $pkgver"
          echo "  wrapper_ver:   $wrapper_ver"
          echo "  claude_ver:    $claude_ver"
          echo "  appimage_name: $appimage_name"

      - name: Compute AppImage checksum
        id: checksum
        run: |
          appimage="artifacts/${{ steps.version.outputs.appimage_name }}"
          echo "Expected path: $appimage"
          if [[ ! -f "$appimage" ]]; then
            echo "::warning::Expected AppImage not found, searching artifacts..."
            appimage=$(find artifacts/ -name '*.AppImage' -not -name '*.zsync' | head -1)
            echo "Fallback found: $appimage"
          fi
          if [[ -z "$appimage" || ! -f "$appimage" ]]; then
            echo "::error::No AppImage found in artifacts"
            ls -la artifacts/
            exit 1
          fi
          sha256=$(sha256sum "$appimage" | awk '{print $1}')
          echo "sha256=$sha256" >> "$GITHUB_OUTPUT"

          echo ""
          echo "=== Checksum result ==="
          echo "  File:   $(basename "$appimage")"
          echo "  Size:   $(stat --printf='%s' "$appimage") bytes"
          echo "  SHA256: $sha256"

      - name: Configure SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan -t ed25519,rsa aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null
          cat > ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          chmod 600 ~/.ssh/config
          echo "SSH configured, known_hosts entries:"
          wc -l ~/.ssh/known_hosts

      - name: Clone AUR repository
        run: |
          git clone ssh://aur@aur.archlinux.org/claude-desktop-appimage.git aur-repo
          echo ""
          echo "=== AUR repo contents ==="
          ls -la aur-repo/
          echo ""
          echo "=== AUR repo git log ==="
          git -C aur-repo log --oneline -5

      - name: Generate PKGBUILD from template
        working-directory: aur-repo
        run: |
          if [[ ! -f PKGBUILD.template ]]; then
            echo "::error::PKGBUILD.template not found in AUR repository"
            echo "Available files:"
            ls -la
            exit 1
          fi

          echo "=== Template before substitution ==="
          cat PKGBUILD.template
          echo ""

          sed \
            -e 's/%%PKGVER%%/${{ steps.version.outputs.pkgver }}/' \
            -e 's/%%APPIMAGE_NAME%%/${{ steps.version.outputs.appimage_name }}/' \
            -e 's/%%SHA256_APPIMAGE%%/${{ steps.checksum.outputs.sha256 }}/' \
            PKGBUILD.template > PKGBUILD

          echo "=== Generated PKGBUILD ==="
          cat PKGBUILD
          echo ""

          echo "=== Diff template vs generated ==="
          diff PKGBUILD.template PKGBUILD || true

      - name: Generate .SRCINFO
        working-directory: aur-repo
        run: |
          # Run makepkg in Arch container to generate .SRCINFO
          docker run --rm -v "$PWD":/pkg -w /pkg archlinux:base bash -c "
            useradd -m builder
            chown builder:builder /pkg
            find /pkg -maxdepth 1 -not -name .git -not -path /pkg -exec chown -R builder:builder {} +
            su builder -c 'makepkg --printsrcinfo > .SRCINFO'
          "
          # Restore ownership after docker (container uid may differ from runner)
          sudo chown -R "$(id -u):$(id -g)" .
          echo "=== Generated .SRCINFO ==="
          cat .SRCINFO

      - name: Show final state (DRY RUN - no push)
        working-directory: aur-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO

          echo "=== git status ==="
          git status

          echo ""
          echo "=== git diff --staged ==="
          git diff --staged

          if git diff --staged --quiet; then
            echo ""
            echo "No changes detected - PKGBUILD is already up to date"
          else
            echo ""
            echo "=== Would commit with message ==="
            echo "Update to v${{ steps.version.outputs.pkgver }}"
            echo ""
            echo "DRY RUN: skipping git commit and push"
          fi
